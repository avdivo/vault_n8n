# VaultN8N

VaultN8N — это минималистичное серверное приложение для безопасного хранения, выдачи и удаления секретов (паролей, токенов и т.п.) через HTTP API. Оно разработано для интеграции с [n8n](https://n8n.io/) или для использования в качестве простого и легковесного хранилища секретов.

Проект создан с упором на простоту, предсказуемость, минимальные зависимости и небольшой размер Docker-образа.

## Оглавление

- [Установка и запуск](#установка-и-запуск)
  - [Быстрый старт для пользователей (рекомендуется)](#быстрый-старт-для-пользователей-рекомендуется)
  - [Запуск для разработки](#запуск-для-разработки)
- [Конфигурация](#конфигурация)
- [Использование API (Примеры Curl)](#использование-api-примеры-curl)
- [Тестирование](#тестирование)
- [Публикация новой версии](#публикация-новой-версии)
- [Общие технические требования](#общие-технические-требования)
- [Советы по безопасности и эксплуатации](#советы-по-безопасности-и-эксплуатации)

---

## Установка и запуск

Существует два основных способа запуска приложения: быстрый старт для обычных пользователей и запуск для разработчиков.

### Быстрый старт для пользователей (рекомендуется)

Этот способ не требует клонирования репозитория и идеально подходит для быстрого развертывания. Все, что вам нужно — это установленный `Docker`, `docker-compose` и `curl`.

1.  **Выполните команду в терминале:**

    ```bash
    curl -sSL https://raw.githubusercontent.com/avdivo/vault_n8n/main/start.sh | bash
    ```

2.  **Что сделает этот скрипт?**
    *   Скачает последнюю версию `docker-compose.yml` из репозитория.
    *   Проверит, существует ли в текущей директории файл `.env`. Если нет — создаст его.
    *   Проверит, заданы ли в `.env` ключи `AUTH_TOKEN` и `ENCRYPTION_KEY`. Если нет — сгенерирует их и добавит в файл.
    *   Запустит последнюю версию приложения из [Docker Hub](https://hub.docker.com/r/avdivo/vault-n8n).

3.  **Готово!**
    Ваше приложение запущено. Необходимые для доступа `AUTH_TOKEN` и `ENCRYPTION_KEY` сохранены в файле `.env` в той же директории, откуда вы запускали скрипт. Сохранность этого файла обеспечивает сохранность ваших данных.

### Запуск для разработки

Этот способ предназначен для тех, кто хочет вносить изменения в код.

1.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/avdivo/vault_n8n.git
    cd vault_n8n
    ```

2.  **Запустите скрипт для разработки:**
    ```bash
    ./start-dev.sh
    ```
    Этот скрипт автоматически подготовит `.env` файл (аналогично пользовательскому скрипту) и запустит `docker-compose`, но **соберет образ из локальных исходников**, что позволит вам сразу видеть ваши изменения.

3.  **Альтернативный ручной запуск (без Docker):**
    Если вы хотите запускать приложение напрямую для отладки:
    ```bash
    # Создайте и активируйте виртуальное окружение
    python -m venv venv
    source venv/bin/activate

    # Установите зависимости
    pip install -r requirements.txt

    # Убедитесь, что .env файл существует (можно запустить ./start-dev.sh один раз)

    # Запустите приложение
    uvicorn app.main:app --host 0.0.0.0 --port 8000
    ```

## Конфигурация

Приложение конфигурируется через переменные окружения, которые автоматически создаются в файле `.env` при первом запуске с помощью скриптов.

-   **`AUTH_TOKEN`**: (Обязательно) Секретный токен для авторизации доступа к API.
-   **`ENCRYPTION_KEY`**: (Обязательно) 64-символьный hex-ключ для шифрования данных.
-   **`DATABASE_PATH`**: (Опционально) Путь к файлу базы данных SQLite. По умолчанию: `./secrets.db`.

## Использование API (Примеры Curl)

Все эндпоинты имеют префикс `/api/v1` и требуют авторизации.

> **Важно:** В примерах ниже используется плейсхолдер `your_secret_token`. Вы должны заменить его на ваш собственный `AUTH_TOKEN`, который был сгенерирован и сохранен в файле `.env`.

**Пример получения вашего токена из `.env`:**
```bash
AUTH_TOKEN=$(grep AUTH_TOKEN .env | cut -d '=' -f2)
```

#### Добавление/Обновление секрета
```bash
curl -X POST "http://localhost:8000/api/v1/secrets/single" \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer $AUTH_TOKEN" \
     -d '{ "key": "my_service_password", "value": "super_secret_password_123" }'
```

#### Получение секретов
```bash
curl -X GET "http://localhost:8000/api/v1/secrets?keys=my_service_password,api_key_prod" \
     -H "Authorization: Bearer $AUTH_TOKEN"
```

#### Удаление секретов
```bash
curl -X DELETE "http://localhost:8000/api/v1/secrets?keys=my_service_password" \
     -H "Authorization: Bearer $AUTH_TOKEN"
```

## Тестирование

Для запуска тестов убедитесь, что вы находитесь в клонированном репозитории и активировали виртуальное окружение.

```bash
# Установите dev-зависимости
pip install -r requirements.txt

# Запустите тесты
PYTHONPATH=$(pwd) pytest
```
Эта команда запускает тесты, корректно обрабатывая импорты модулей приложения.

## Публикация новой версии

Этот проект использует [GitHub Actions](https://github.com/features/actions) для автоматической сборки и публикации Docker-образа в [Docker Hub](https://hub.docker.com/).

Публикация новой версии происходит при создании и отправке в репозиторий нового Git-тега, соответствующего формату `v*.*.*` (например, `v1.0.0`, `v1.2.3`).

**Порядок действий для выпуска новой версии:**

1.  Убедитесь, что все последние изменения находятся в ветке `main`.
2.  Создайте новый тег, следуя принципам [семантического версионирования](https://semver.org/lang/ru/).
    ```bash
    # Пример создания тега для версии 1.0.1
    git tag v1.0.1
    ```
3.  Отправьте тег в удаленный репозиторий.
    ```bash
    git push origin v1.0.1
    ```
4.  После этого GitHub Actions автоматически запустит процесс сборки и публикации.

## Общие технические требования

- **Язык**: Python 3.11
- **Web-фреймворк**: FastAPI
- **База данных**: SQLite
- **Шифрование**: AES-256-GCM
- **Тесты**: `pytest`
- **Контейнеризация**: Docker

## Советы по безопасности и эксплуатации

-   **HTTPS**: Всегда запускайте VaultN8N за обратным прокси (например, Nginx, Traefik), который обеспечивает HTTPS.
-   **Сетевая изоляция**: Ограничьте доступ к API VaultN8N только для доверенных сервисов (например, n8n).
-   **Управление ключами**: `ENCRYPTION_KEY` и `AUTH_TOKEN` в файле `.env` должны быть надежно защищены.
-   **Резервное копирование**: Регулярно создавайте резервные копии файла базы данных (`secrets.db`).